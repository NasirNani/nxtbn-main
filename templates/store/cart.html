{% extends "account/base.html" %}
{% load i18n currency %}
{% get_current_language as LANGUAGE_CODE %}

{% block head_title %}{% if LANGUAGE_CODE == 'tr' %}Sepet | Flexy Medical{% else %}Shopping Cart | Flexy Medical{% endif %}{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 min-h-screen">
    <nav aria-label="Breadcrumb" class="flex mb-8">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li><a class="inline-flex items-center text-sm font-medium text-slate-500 hover:text-primary dark:text-slate-400" href="{% url 'home' %}">{% if LANGUAGE_CODE == 'tr' %}Ana Sayfa{% else %}Home{% endif %}</a></li>
            <li><span class="material-icons text-slate-300 text-sm mx-1">chevron_right</span></li>
            <li class="text-sm font-medium text-slate-800 dark:text-slate-200">{% if LANGUAGE_CODE == 'tr' %}Sepet{% else %}Shopping Cart{% endif %}</li>
        </ol>
    </nav>

    <h1 class="text-3xl font-bold text-text-main dark:text-white mb-8">{% if LANGUAGE_CODE == 'tr' %}Sepetiniz{% else %}Your Shopping Cart{% endif %} <span class="text-slate-400 font-normal text-xl ml-2">({{ items|length }})</span></h1>

    {% if items %}
    <div class="lg:grid lg:grid-cols-12 lg:gap-12 items-start">
        <div class="lg:col-span-8">
            <div class="hidden md:grid grid-cols-12 text-sm font-medium text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 pb-4 mb-6">
                <div class="col-span-6">{% if LANGUAGE_CODE == 'tr' %}Urun{% else %}Product{% endif %}</div>
                <div class="col-span-2 text-center">{% if LANGUAGE_CODE == 'tr' %}Adet{% else %}Quantity{% endif %}</div>
                <div class="col-span-2 text-right">{% if LANGUAGE_CODE == 'tr' %}Fiyat{% else %}Price{% endif %}</div>
                <div class="col-span-2 text-right">{% if LANGUAGE_CODE == 'tr' %}Toplam{% else %}Total{% endif %}</div>
            </div>

            {% for item in items %}
            <div class="bg-white dark:bg-[#2a2018] rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 p-4 md:p-6 mb-4 transition-all hover:shadow-md">
                <div class="md:grid md:grid-cols-12 md:gap-6 items-center">
                    <div class="col-span-6 flex gap-4 md:gap-6">
                        <div class="w-24 h-24 md:w-28 md:h-28 flex-shrink-0 bg-slate-50 dark:bg-slate-800 rounded-lg overflow-hidden border border-slate-100 dark:border-slate-700">
                            {% with cart_image=item.variant.variant_image.first %}
                            {% if cart_image %}
                                <img alt="{{ item.product.name }}" class="w-full h-full object-cover" src="{{ cart_image.image.url }}">
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-500">{% if LANGUAGE_CODE == 'tr' %}Gorsel Yok{% else %}No Img{% endif %}</div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        <div class="flex flex-col justify-between py-1">
                            <div>
                                <h3 class="text-lg font-semibold text-text-main dark:text-white mb-1"><a href="{% url 'product_detail' item.product.id %}">{{ item.product.name }}</a></h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400">{% if LANGUAGE_CODE == 'tr' %}Varyant:{% else %}Variant:{% endif %} {{ item.variant.name|default_if_none:"Default"|default:"Default" }}</p>
                                <p class="text-sm text-green-600 font-medium mt-1">{% if LANGUAGE_CODE == 'tr' %}Stokta{% else %}In Stock{% endif %}</p>
                            </div>
                            <form method="post" action="{% url 'cart_remove' item.variant.id %}" class="mt-2 md:mt-0">
                                {% csrf_token %}
                                <button type="submit" class="text-sm text-red-500 hover:text-red-700 flex items-center gap-1 w-max transition-colors"><span class="material-icons text-base">delete_outline</span> {% if LANGUAGE_CODE == 'tr' %}Kaldir{% else %}Remove{% endif %}</button>
                            </form>
                        </div>
                    </div>

                    <div class="col-span-2 flex flex-col md:flex-row justify-center items-center mt-4 md:mt-0">
                        <form method="post" action="{% url 'cart_update' item.variant.id %}" class="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg h-9">
                            {% csrf_token %}
                            <button type="submit" name="quantity" value="{{ item.quantity|add:'-1' }}" class="w-8 h-full flex items-center justify-center text-slate-500 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 rounded-l-lg transition-colors" {% if item.quantity <= 1 %}disabled{% endif %}>-</button>
                            <input class="w-10 text-center border-0 p-0 text-sm bg-transparent focus:ring-0 text-text-main dark:text-white font-medium" readonly type="text" value="{{ item.quantity }}">
                            <button type="submit" name="quantity" value="{{ item.quantity|add:'1' }}" class="w-8 h-full flex items-center justify-center text-slate-500 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 rounded-r-lg transition-colors">+</button>
                        </form>
                    </div>

                    <div class="col-span-2 hidden md:block text-right"><span class="text-slate-500 dark:text-slate-400">{{ item.price_per_unit|try_currency }}</span></div>

                    <div class="col-span-2 flex justify-between md:block md:text-right mt-4 md:mt-0 pt-4 md:pt-0 border-t md:border-t-0 border-slate-100 dark:border-slate-800">
                        <span class="md:hidden text-sm font-medium text-slate-500">{% if LANGUAGE_CODE == 'tr' %}Toplam:{% else %}Total:{% endif %}</span>
                        <span class="text-lg font-bold text-text-main dark:text-white">{{ item.subtotal|try_currency }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}

            <div class="flex justify-between items-center mt-6">
                <a class="flex items-center gap-2 text-primary hover:text-primary-hover font-medium transition-colors" href="{% url 'products_list' %}"><span class="material-icons text-sm">arrow_back</span> {% if LANGUAGE_CODE == 'tr' %}Alisverise Devam Et{% else %}Continue Shopping{% endif %}</a>
            </div>
        </div>

        <div class="lg:col-span-4 mt-8 lg:mt-0">
            <div class="bg-white dark:bg-[#2a2018] rounded-xl shadow-lg border border-slate-100 dark:border-slate-800 p-6 sticky top-24">
                <h2 class="text-xl font-bold text-text-main dark:text-white mb-6">{% if LANGUAGE_CODE == 'tr' %}Siparis Ozeti{% else %}Order Summary{% endif %}</h2>

                <form method="post" class="mb-4 space-y-2">
                    {% csrf_token %}
                    <label class="text-xs font-semibold text-gray-500 uppercase">{% if LANGUAGE_CODE == 'tr' %}Kupon{% else %}Coupon{% endif %}</label>
                    <div class="flex gap-2">
                        <input type="text" name="promo_code" value="{{ promo_code }}" placeholder="SAVE10" class="w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-900">
                        <button type="submit" name="action" value="apply_coupon" class="px-3 py-2 rounded-lg bg-primary text-white text-sm font-semibold">{% if LANGUAGE_CODE == 'tr' %}Uygula{% else %}Apply{% endif %}</button>
                    </div>
                    {% if promo_code %}
                        <button type="submit" name="action" value="remove_coupon" class="text-xs text-red-600 hover:underline">{% if LANGUAGE_CODE == 'tr' %}Kuponu Kaldir{% else %}Remove coupon{% endif %}</button>
                    {% endif %}
                </form>

                <form method="post" class="mb-6 space-y-2">
                    {% csrf_token %}
                    <label class="text-xs font-semibold text-gray-500 uppercase">{% if LANGUAGE_CODE == 'tr' %}Hediye Karti{% else %}Gift Card{% endif %}</label>
                    <div class="flex gap-2">
                        <input type="text" name="gift_card_code" value="{{ gift_card_code }}" placeholder="GIFT-XXXX" class="w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-900">
                        <button type="submit" name="action" value="apply_gift_card" class="px-3 py-2 rounded-lg bg-primary text-white text-sm font-semibold">{% if LANGUAGE_CODE == 'tr' %}Uygula{% else %}Apply{% endif %}</button>
                    </div>
                    {% if gift_card_code %}
                        <button type="submit" name="action" value="remove_gift_card" class="text-xs text-red-600 hover:underline">{% if LANGUAGE_CODE == 'tr' %}Hediye Kartini Kaldir{% else %}Remove gift card{% endif %}</button>
                    {% endif %}
                </form>

                <div class="space-y-3 mb-6">
                    <div class="flex justify-between text-slate-600 dark:text-slate-300"><span>{% if LANGUAGE_CODE == 'tr' %}Ara Toplam{% else %}Subtotal{% endif %}</span><span class="font-medium">{{ subtotal|try_currency }}</span></div>
                    {% if discount > 0 %}
                    <div class="flex justify-between text-green-700"><span>{% if LANGUAGE_CODE == 'tr' %}Kupon Indirimi{% else %}Coupon Discount{% endif %}</span><span>-{{ discount|try_currency }}</span></div>
                    {% endif %}
                    <div class="flex justify-between text-slate-600 dark:text-slate-300"><span>{% if LANGUAGE_CODE == 'tr' %}Vergi{% else %}Tax{% endif %}</span><span class="font-medium">{{ tax|try_currency }}</span></div>
                    <div class="flex justify-between text-slate-600 dark:text-slate-300"><span>{% if LANGUAGE_CODE == 'tr' %}Kargo{% else %}Shipping{% endif %}</span><span class="font-medium">{{ shipping|try_currency }}</span></div>
                    {% if gift_card_applied > 0 %}
                    <div class="flex justify-between text-green-700"><span>{% if LANGUAGE_CODE == 'tr' %}Hediye Karti{% else %}Gift Card{% endif %}</span><span>-{{ gift_card_applied|try_currency }}</span></div>
                    {% endif %}
                </div>

                <div class="border-t border-slate-100 dark:border-slate-700 my-6"></div>
                <div class="flex justify-between items-center mb-6"><span class="text-lg font-bold text-text-main dark:text-white">{% if LANGUAGE_CODE == 'tr' %}Toplam{% else %}Total{% endif %}</span><span class="text-2xl font-bold text-text-main dark:text-white">{{ total|try_currency }}</span></div>
                <a href="{% url 'checkout' %}" class="w-full bg-primary hover:bg-primary-hover text-white font-bold py-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex justify-center items-center gap-2 group">{% if LANGUAGE_CODE == 'tr' %}Odeme Adimina Gec{% else %}Proceed to Checkout{% endif %} <span class="material-icons group-hover:translate-x-1 transition-transform">arrow_forward</span></a>
                <div class="flex items-center justify-center gap-2 text-xs text-slate-500 dark:text-slate-400 mt-4 pt-4 border-t border-slate-100 dark:border-slate-700"><span class="material-icons text-base text-green-600">lock</span>{% if LANGUAGE_CODE == 'tr' %}Guvenli sifreli odeme{% else %}Secure encrypted checkout{% endif %}</div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-20 bg-white dark:bg-[#2a2018] rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
        <span class="material-icons text-6xl text-slate-300 mb-4">shopping_cart</span>
        <h2 class="text-2xl font-bold text-text-main dark:text-white mb-2">{% if LANGUAGE_CODE == 'tr' %}Sepetiniz bos{% else %}Your cart is empty{% endif %}</h2>
        <p class="text-slate-500 mb-8">{% if LANGUAGE_CODE == 'tr' %}Henuz urun eklemediniz.{% else %}Looks like you have not added any items yet.{% endif %}</p>
        <a class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary-dark transition-colors" href="{% url 'products_list' %}">{% if LANGUAGE_CODE == 'tr' %}Alisverise Basla{% else %}Start Shopping{% endif %}</a>
    </div>
    {% endif %}
</main>
{% endblock content %}
